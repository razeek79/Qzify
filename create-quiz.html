<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Quiz - Qzify</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="create-quiz.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
        <a class="navbar-brand navbar-brand-center" href="index.html">
            <img src="/Qzify-images/logo2.png" alt="Qzify Logo" style="height: 50px;"/>
        </a>
    </nav>

    <div class="container main-content">
        <h2 class="page-title text-center text-md-left">Create New Quiz</h2>

        <form id="createQuizForm">
            
            <div class="card-box">
                <h5 class="section-title"><i class="fas fa-info-circle"></i> Quiz Details</h5>
                <div class="form-group">
                    <label>Quiz Title</label>
                    <input type="text" id="quizTitle" class="form-control" placeholder="e.g. Math Final Exam" required>
                </div>
                <div class="form-group">
                    <label>Description (Optional)</label>
                    <textarea id="quizDesc" class="form-control" rows="2" placeholder="Instructions for students..."></textarea>
                </div>
            </div>

            <div class="card-box">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="section-title m-0"><i class="fas fa-question-circle"></i> Questions</h5>
                </div>
                
                <div id="questionsList" class="mb-3">
                    <div class="text-muted text-center p-3" id="emptyMsg">No questions added yet.</div>
                </div>

                <button type="button" class="btn btn-outline-dark btn-block btn-dashed" data-toggle="modal" data-target="#questionModal">
                    <i class="fas fa-plus"></i> Add Question
                </button>
            </div>

            <div class="card-box">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="section-title m-0"><i class="fas fa-certificate"></i> Certificate</h5>
                    <div class="custom-control custom-switch">
                        <input type="checkbox" class="custom-control-input" id="certToggle">
                        <label class="custom-control-label" for="certToggle">Enable Certificate</label>
                    </div>
                </div>

                <div id="certSettingsWrapper" class="mt-4" style="display: none;">
                    <label class="font-weight-bold">Select Template</label>
                    <div class="template-grid mb-4">
                        <div class="template-option selected" id="tmpl1" data-value="template1">
                            <div class="template-preview" style="background: #f0f0f0; border: 2px solid #333;"></div>
                            <small>Classic</small>
                        </div>
                        <div class="template-option" id="tmpl2" data-value="template2">
                            <div class="template-preview" style="background: #e3f2fd; border: 2px solid #2196f3;"></div>
                            <small>Blue Diploma</small>
                        </div>
                        <div class="template-option" id="tmpl3" data-value="template3">
                            <div class="template-preview" style="background: #fff3e0; border: 2px solid #ff9800;"></div>
                            <small>Gold Award</small>
                        </div>
                    </div>
                    <input type="hidden" id="selectedTemplate" value="template1">

                    <button type="button" class="btn btn-sm btn-outline-secondary mb-3" id="customizeCertBtn">
                        <i class="fas fa-pen"></i> Customize Text
                    </button>

                    <div id="certCustomFields" style="display: none;">
                        <div class="form-group">
                            <label>Heading</label>
                            <input type="text" id="certHeading" class="form-control" value="Certificate of Participation">
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="certBody" class="form-control" rows="3">This certificate is proudly presented to acknowledge your active participation in this event. Your enthusiasm and effort contributed to the success of the program.</textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div class="fixed-bottom-bar d-md-static">
                <button type="submit" class="btn btn-black btn-lg btn-block" id="createQuizBtn">Create Quiz</button>
            </div>

        </form>
    </div>

    <div class="modal fade" id="questionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Question</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Question Text</label>
                        <textarea id="newQText" class="form-control" rows="2" placeholder="Enter your question here..."></textarea>
                    </div>
                    <label>Options (Select the correct answer)</label>
                    
                    <div class="input-group mb-2">
                        <div class="input-group-prepend">
                            <div class="input-group-text">
                                <input type="radio" name="correctAnswer" value="0" checked>
                            </div>
                        </div>
                        <input type="text" class="form-control option-input" placeholder="Option 1">
                    </div>

                    <div class="input-group mb-2">
                        <div class="input-group-prepend">
                            <div class="input-group-text">
                                <input type="radio" name="correctAnswer" value="1">
                            </div>
                        </div>
                        <input type="text" class="form-control option-input" placeholder="Option 2">
                    </div>

                    <div class="input-group mb-2">
                        <div class="input-group-prepend">
                            <div class="input-group-text">
                                <input type="radio" name="correctAnswer" value="2">
                            </div>
                        </div>
                        <input type="text" class="form-control option-input" placeholder="Option 3">
                    </div>

                    <div class="input-group mb-2">
                        <div class="input-group-prepend">
                            <div class="input-group-text">
                                <input type="radio" name="correctAnswer" value="3">
                            </div>
                        </div>
                        <input type="text" class="form-control option-input" placeholder="Option 4">
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-black" id="saveQuestionBtn">Add</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script type="module">
        import { supabase } from "./config.js";

        // STATE
        let questions = []; 

        // 1. AUTH CHECK
        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) window.location.href = "login.html";
        }
        checkAuth();

        // 2. CERTIFICATE TOGGLE LOGIC (SHOW/HIDE)
        const certToggle = document.getElementById('certToggle');
        const certWrapper = document.getElementById('certSettingsWrapper');
        
        certToggle.addEventListener('change', function() {
            if (this.checked) {
                certWrapper.style.display = 'block'; // Show if ON
            } else {
                certWrapper.style.display = 'none'; // Hide if OFF
            }
        });

        // 3. TEMPLATE SELECTION LOGIC
        // Using Event Listeners instead of inline onclick for safety
        const templates = document.querySelectorAll('.template-option');
        templates.forEach(t => {
            t.addEventListener('click', function() {
                // Remove selected from all
                templates.forEach(el => el.classList.remove('selected'));
                // Add to clicked
                this.classList.add('selected');
                // Update hidden input
                document.getElementById('selectedTemplate').value = this.dataset.value;
            });
        });

        // 4. CUSTOMIZE TOGGLE
        const customizeBtn = document.getElementById('customizeCertBtn');
        const customFields = document.getElementById('certCustomFields');

        customizeBtn.addEventListener('click', function() {
            if (customFields.style.display === 'none') {
                customFields.style.display = 'block';
                this.innerHTML = '<i class="fas fa-times"></i> Hide Customization';
            } else {
                customFields.style.display = 'none';
                this.innerHTML = '<i class="fas fa-pen"></i> Customize Text';
            }
        });

        // 5. QUESTION LOGIC
        // Expose remove function to window so the HTML onclick can find it
        window.removeQuestion = function(index) {
            questions.splice(index, 1);
            renderQuestions();
        }

        // Add Question Logic (Fixed)
        document.getElementById('saveQuestionBtn').addEventListener('click', function() {
            const text = document.getElementById('newQText').value;
            // Get all option inputs that are not empty
            const optionInputs = document.querySelectorAll('.option-input');
            const options = [];
            
            optionInputs.forEach(input => {
                if(input.value.trim() !== "") {
                    options.push(input.value.trim());
                }
            });

            const correctRadio = document.querySelector('input[name="correctAnswer"]:checked');
            const correctIndex = correctRadio ? parseInt(correctRadio.value) : 0;

            // Validation
            if(!text) {
                alert("Please enter a question.");
                return;
            }
            if(options.length < 2) {
                alert("Please fill in at least 2 options.");
                return;
            }

            // Create Object
            const questionObj = {
                text: text,
                options: options.map((optText, idx) => ({
                    text: optText,
                    isCorrect: idx === correctIndex
                }))
            };

            questions.push(questionObj);
            renderQuestions();
            
            // Reset Modal & Close
            document.getElementById('newQText').value = "";
            optionInputs.forEach(i => i.value = "");
            // Reset radio to first option
            document.querySelectorAll('input[name="correctAnswer"]')[0].checked = true;
            
            $('#questionModal').modal('hide');
        });

        function renderQuestions() {
            const list = document.getElementById('questionsList');
            if(questions.length === 0) {
                list.innerHTML = '<div class="text-muted text-center p-3">No questions added yet.</div>';
                return;
            }

            list.innerHTML = questions.map((q, i) => `
                <div class="question-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>Q${i+1}: ${q.text}</strong>
                            <br>
                            <small class="text-muted">
                                Correct Answer: ${q.options.find(o => o.isCorrect)?.text || 'None'}
                            </small>
                        </div>
                        <button type="button" class="btn btn-sm text-danger" onclick="window.removeQuestion(${i})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // 6. SUBMIT FORM
        document.getElementById('createQuizForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('createQuizBtn');
            
            if(questions.length === 0) {
                alert("Please add at least one question!");
                return;
            }

            btn.disabled = true;
            btn.textContent = "Creating...";

            try {
                const { data: { user } } = await supabase.auth.getUser();
                if(!user) throw new Error("User not found");

                const joinCode = Math.random().toString(36).substring(2, 8).toUpperCase();
                const certEnabled = document.getElementById('certToggle').checked;

                // A. Insert Quiz
                const { data: quizData, error: quizError } = await supabase.from('quizzes').insert([{
                    creator_id: user.id,
                    title: document.getElementById('quizTitle').value,
                    description: document.getElementById('quizDesc').value,
                    join_code: joinCode,
                    cert_enabled: certEnabled,
                    cert_heading: certEnabled ? document.getElementById('certHeading').value : null,
                    cert_description: certEnabled ? document.getElementById('certBody').value : null,
                    cert_template_id: certEnabled ? document.getElementById('selectedTemplate').value : null
                }]).select();

                if (quizError) throw quizError;
                const quizId = quizData[0].id;

                // B. Insert Questions & Options
                for (const q of questions) {
                    const { data: qData, error: qError } = await supabase.from('questions').insert([{
                        quiz_id: quizId,
                        question_text: q.text
                    }]).select();

                    if (qError) throw qError;
                    const qId = qData[0].id;

                    const optionsPayload = q.options.map(opt => ({
                        question_id: qId,
                        option_text: opt.text,
                        is_correct: opt.is_correct || opt.isCorrect 
                    }));
                    
                    const { error: optError } = await supabase.from('options').insert(optionsPayload);
                    if (optError) throw optError;
                }

                alert(`Success! Quiz Created.\nJoin Code: ${joinCode}`);
                window.location.href = "index.html"; 

            } catch (err) {
                console.error(err);
                alert("Error: " + err.message);
                btn.disabled = false;
                btn.textContent = "Create Quiz";
            }
        });
    </script>
</body>
</html>